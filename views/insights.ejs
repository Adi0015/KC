<!-- include login.ejs -->
<br>
<br>
<h1>Insights</h1>
<label for="branchFilter">Branch:</label>
<select id="branchFilter" onchange="filterData()">
  <option value="">All</option>
  <option value="Andheri">Andheri</option>
  <option value="Charkop">Charkop</option>
  <option value="Borivali">Borivali</option>
  <option value="Kandivali">Kandivali</option>
  <!-- Add more options as needed -->
</select>

<label for="standardFilter">Standard:</label>
<select id="standardFilter" onchange="filterData()">
  <option value="">All</option>
  <option value="Play Group">Play Group</option>
  <option value="Nursery">Nursery</option>
  <option value="Jr. KG">Jr. KG</option>
  <option value="Sr. KG">Sr. KG</option>
  <!-- Add more options as needed -->
</select>

<div class="childname">
  <label for="childNameFilter">Student Name:</label>
  <input type="text" id="childNameFilter" placeholder="Enter student name" oninput="filterData()">
</div>

<br>

<table id="data-table">
  <thead>
    <tr>
      <th>Student Name</th>
      <th>Branch</th>
      <th>Standard</th>
      <th>Email</th>
      <th>Whats App no.</th>
      <th>Total Fees</th>
      <th>Fees Paid</th>
      <th>Remaining Fees</th>
      <th>Action</th>
      <th>Receipt</th>
    </tr>
  </thead>
  <tbody>
    <% admissions.forEach(function(admission) { %>
      <tr>
        <td class="editable" contenteditable="true" data-id="<%= admission.id %>" data-field="childname">
          <%= admission.childname %>
        </td>
        <td>
          <%= admission.branch %>
        </td>
        <td>
          <%= admission.standard %>
        </td>
        <td >
          <%= admission.email %>
        </td>
        <td>
          <%= admission.whatsapp %>
        </td>
        <td class="editable" contenteditable="true" data-id="<%= admission.id %>" data-field="totalFees">
          <%= admission.totalFees %>
        </td>
        <td class="editable" contenteditable="true" data-id="<%= admission.id %>" data-field="feespaid">
          <%= admission.feespaid %>
        </td>
        <td class="editable" contenteditable="true" data-id="<%= admission.id %>" data-field="remainingFees">
          <%= admission.totalFees - admission.feespaid %>
        </td>
        <td>
          <button onclick="updateData('<%= admission.id %>')">Update</button>
        </td>
        <td>
          <button onclick="downloadReceipt('<%= admission.id %>')">Download Receipt</button>
        </td>
      </tr>
    <% }); %>
  </tbody>
</table>

<br>

<button class="revenue" onclick="sumFees()">Calculate Revenue</button>
<div id="fees-summary"></div>

<script src="/script/updateData.js"></script>
<script>
  function filterData() {
    var branchFilter = document.getElementById('branchFilter').value.trim().toLowerCase();
    var standardFilter = document.getElementById('standardFilter').value.trim().toLowerCase();
    var childNameFilter = document.getElementById('childNameFilter').value.trim().toLowerCase();
    var rows = document.querySelectorAll('#data-table tbody tr');

    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var childName = row.getElementsByTagName('td')[0].innerText.trim().toLowerCase();
      var branch = row.getElementsByTagName('td')[1].innerText.trim().toLowerCase();
      var standard = row.getElementsByTagName('td')[2].innerText.trim().toLowerCase();

      if ((branchFilter && branch !== branchFilter) || (standardFilter && standard !== standardFilter) || (childNameFilter && childName.indexOf(childNameFilter) === -1)) {
        row.style.display = 'none';
      } else {
        row.style.display = '';
      }
    }
  }

  function sumFees() {
    var totalFeesSum = 0;
    var feesPaidSum = 0;
    var rows = document.querySelectorAll('#data-table tbody tr');

    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var totalFeesCell = row.getElementsByTagName('td')[5];
      var feesPaidCell = row.getElementsByTagName('td')[6];
      var totalFees = parseInt(totalFeesCell.innerText);
      var feesPaid = parseInt(feesPaidCell.innerText);

      if (!isNaN(totalFees)) {
        totalFeesSum += totalFees;
      }

      if (!isNaN(feesPaid)) {
        feesPaidSum += feesPaid;
      }
    }

    var summaryDiv = document.getElementById('fees-summary');
    summaryDiv.innerText = "Total Fees: " + totalFeesSum + ", Fees Paid: " + feesPaidSum;
  }

  function downloadReceipt(admissionId) {
    // Use the admissionId to identify the specific student and download the receipt
    // Implement your download logic here, such as making an API call or generating a downloadable file
    // You can use JavaScript's `fetch` or an AJAX library like jQuery to perform the download
    // Example code (using fetch):

    fetch(`/receipt/download/${admissionId}`)
      .then(response => response.blob())
      .then(blob => {
        // Create a temporary download link and trigger the download
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'fee_receipt.pdf'; // Set the desired file name
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      })
      .catch(error => {
        console.error('Failed to download receipt:', error);
      });
  }
</script>
